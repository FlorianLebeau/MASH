<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MASH — ENTRE2</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:860px}
    .card{padding:16px;border:1px solid #ddd;border-radius:14px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:999px}
    .muted{opacity:.7}
    button{padding:10px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    input[type="text"]{padding:10px;border-radius:10px;border:1px solid #ccc;min-width:260px}

    .sliderBox{position:relative;height:56px;margin-top:12px;}
    .track{position:absolute;left:0; right:0;top:26px;height:6px;border-radius:999px;background:#e6e6e6;}
    .range{position:absolute;top:26px;height:6px;border-radius:999px;background:#111;left:0%;right:0%;}
    .thumb{pointer-events:none;position:absolute;left:0; right:0;top:14px;width:100%;height:32px;margin:0;background:transparent;-webkit-appearance:none;appearance:none;}
    .thumb::-webkit-slider-runnable-track{height:6px;background:transparent;}
    .thumb::-moz-range-track{height:6px;background:transparent;}
    .thumb::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;appearance:none;height:20px;width:20px;border-radius:50%;border:2px solid #111;background:#fff;cursor:pointer;margin-top:-7px;}
    .thumb::-moz-range-thumb{pointer-events:auto;height:20px;width:20px;border-radius:50%;border:2px solid #111;background:#fff;cursor:pointer;}

    .ticks{position:absolute;left:0; right:0;top:2px;height:18px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;}
    .tick{position:relative;width:1px;height:10px;background:#777;opacity:.9;}
    .tickLabel{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:11px;opacity:.7;white-space:nowrap;}
  </style>
</head>

<body>
  <h1>ENTRE2</h1>

  <div class="row">
    <span class="pill" id="qPill">Q: -/10</span>
    <span class="pill" id="scalePill">scale: -</span>
    <span class="pill" id="unitPill">unit: -</span>
    <span class="pill" id="intervalPill">intervalle: -</span>
  </div>

  <!-- START -->
  <div class="card" id="startCard">
    <div style="font-weight:700;margin-bottom:10px;">Avant de commencer</div>
    <div class="row">
      <input id="playerName" type="text" placeholder="Ton pseudo" />
      <button id="startBtn" disabled>Commencer</button>
      <span class="muted" id="startHint"></span>
    </div>
  </div>

  <!-- QUESTION -->
  <div id="gameArea" style="display:none;">
    <div class="card">
      <div id="aff" style="font-weight:800;font-size:18px;">—</div>
      <div class="muted" id="qid" style="margin-top:6px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:10px;">Choisis ton intervalle</div>

      <div class="sliderBox">
        <div class="ticks" id="ticksBar"></div>

        <div class="track"></div>
        <div class="range" id="rangeFill"></div>

        <input id="minR" class="thumb thumb--left" type="range" />
        <input id="maxR" class="thumb thumb--right" type="range" />
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="nextBtn">Suivant</button>
        <span class="muted" id="nextHint"></span>
      </div>
    </div>
  </div>

  <p class="muted" id="status"></p>

<script>
  // ---- Config ----
  const BASE = "https://script.google.com/macros/s/AKfycbxkzjXgoGlb456tMCTwF4TLdtwdYpBUHZuN5ZEDoOP4Sg4CtNrV1-9Tnv4KSj1o0UR6/exec";
  const WRITE_TOKEN = "YUKI"; // mets "" si tu n'utilises pas de token
  const QUESTIONS_PER_ROUND = 10;
  const TICKS_COUNT = 10; // doit matcher ENTRE2_TICKS_COUNT côté Apps Script

  const sessionId = (localStorage.getItem("mash_sessionId") || "").trim();
  const gameName = "ENTRE2";

  const playerId = localStorage.getItem("mash_playerId") || crypto.randomUUID();
  localStorage.setItem("mash_playerId", playerId);

  // ---- DOM ----
  const qPill = document.getElementById("qPill");
  const aff = document.getElementById("aff");
  const qid = document.getElementById("qid");
  const scalePill = document.getElementById("scalePill");
  const unitPill = document.getElementById("unitPill");
  const intervalPill = document.getElementById("intervalPill");
  const statusEl = document.getElementById("status");

  const startCard = document.getElementById("startCard");
  const gameArea = document.getElementById("gameArea");
  const playerNameInput = document.getElementById("playerName");
  const startBtn = document.getElementById("startBtn");
  const startHint = document.getElementById("startHint");

  const nextBtn = document.getElementById("nextBtn");
  const nextHint = document.getElementById("nextHint"); // (réservé si tu veux des hints)

  const minR = document.getElementById("minR");
  const maxR = document.getElementById("maxR");
  const rangeFill = document.getElementById("rangeFill");
  const ticksBar = document.getElementById("ticksBar");

  // ---- State ----
  let isSubmitting = false;
  let unit = "";
  let cfg = null;

  let currentPlayerName = "";
  let askedQids = [];
  let collected = []; // {qId,min,max}
  let currentQ = null;
  let qNum = 0;

  // ---- Helpers ----
  function setStatus(msg){ statusEl.textContent = msg || ""; }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cb] = (data) => {
        delete window[cb];
        script.remove();
        resolve(data);
      };

      script.onerror = () => {
        delete window[cb];
        script.remove();
        reject(new Error("JSONP load failed"));
      };

      const sep = url.includes("?") ? "&" : "?";
      script.src = `${url}${sep}callback=${encodeURIComponent(cb)}`;
      document.head.appendChild(script);
    });
  }

  function parseScaleGroup(raw) {
    const s = String(raw ?? "").toLowerCase().trim();
    const n = Number(s);
    if (Number.isFinite(n) && (n === 1 || n === 2 || n === 3)) return n;
    if (s.includes("1") && s.includes("10")) return 1;
    if (s.includes("10") && s.includes("100") && !s.includes("1000")) return 2;
    if (s.includes("100") && s.includes("1000")) return 3;
    return 1;
  }

  function configForScaleGroup(rawGroup) {
    const g = parseScaleGroup(rawGroup);

    let min, max;
    if (g === 1) { min = 1;   max = 10; }
    if (g === 2) { min = 10;  max = 100; }
    if (g === 3) { min = 100; max = 1000; }

    // 10 crans => 9 intervalles
    const step = (max - min) / (TICKS_COUNT - 1);
    const stepInt = Math.round(step);

    return { group: g, min, max, step: stepInt, ticksCount: TICKS_COUNT };
  }

  function buildTicks({min, step, ticksCount}) {
    const out = [];
    for (let i = 0; i < ticksCount; i++) out.push(min + i * step);
    return out;
  }

  function renderTicks(cfg) {
    const ticks = buildTicks(cfg);
    ticksBar.innerHTML = "";
    ticks.forEach((t, idx) => {
      const tick = document.createElement("div");
      tick.className = "tick";

      const showLabel = (idx === 0) || (idx === ticks.length - 1);
      if (showLabel) {
        const lab = document.createElement("div");
        lab.className = "tickLabel";
        lab.textContent = String(t);
        tick.appendChild(lab);
      }

      ticksBar.appendChild(tick);
    });
  }

  function setSliders({min, max, step}) {
    [minR, maxR].forEach(r => { r.min = min; r.max = max; r.step = step; });
    minR.value = min;
    maxR.value = max;
    minR.disabled = false;
    maxR.disabled = false;
  }

  function clampAndSync(which) {
    let a = Number(minR.value);
    let b = Number(maxR.value);

    if (a > b) {
      if (which === "min") b = a;
      else a = b;
      minR.value = a;
      maxR.value = b;
    }

    const min = Number(minR.min);
    const max = Number(minR.max);
    const leftPct = ((a - min) / (max - min)) * 100;
    const rightPct = 100 - ((b - min) / (max - min)) * 100;

    rangeFill.style.left = `${leftPct}%`;
    rangeFill.style.right = `${rightPct}%`;

    intervalPill.textContent = `intervalle: ${a} – ${b} ${unit}`.trim();
  }

  function captureCurrentInterval() {
    const a = Number(minR.value);
    const b = Number(maxR.value);
    return { min: Math.min(a,b), max: Math.max(a,b) };
  }

  // ---- Events sliders ----
  minR.addEventListener("input", () => clampAndSync("min"));
  maxR.addEventListener("input", () => clampAndSync("max"));

  // ---- Game flow ----
  async function loadNextQuestion() {
    qNum += 1;
    qPill.textContent = `Q: ${qNum}/${QUESTIONS_PER_ROUND}`;
    setStatus(`Chargement question ${qNum}/${QUESTIONS_PER_ROUND}…`);

    const exclude = askedQids.join(",");
    const url = `${BASE}?action=entre2_question&session=${encodeURIComponent(sessionId)}&n=${qNum}`;

    // JSONP pour éviter CORS
    const data = await jsonp(url);

    if (!data.ok) { setStatus(`Erreur: ${data.error}`); return; }

    currentQ = data;
    askedQids.push(data.qId);

    aff.textContent = data.affirmation;
    qid.textContent = `qId: ${data.qId}`;

    unit = data.unitGroup || "";
    unitPill.textContent = `unit: ${unit || "-"}`;

    cfg = configForScaleGroup(data.scaleGroup);
    scalePill.textContent = `scale: ${cfg.group}`;

    renderTicks(cfg);
    setSliders(cfg);
    clampAndSync("min");

    nextBtn.disabled = false;
    nextBtn.textContent = (qNum >= QUESTIONS_PER_ROUND) ? "Terminer" : "Suivant";
    setStatus(`Question ${qNum}/${QUESTIONS_PER_ROUND} ✅`);
  }

  async function submitRound() {
    if (collected.length !== QUESTIONS_PER_ROUND) {
      setStatus(`Erreur: ${collected.length} réponses (attendu ${QUESTIONS_PER_ROUND})`);
      isSubmitting = false;
      nextBtn.disabled = false;
      return;
    }

    setStatus("Envoi des réponses…");

    const payload = {
      action: "entre2_submit",
      token: WRITE_TOKEN,
      sessionId,
      game: gameName,
      playerId,
      playerName: currentPlayerName,
      answers: collected
    };

    const res = await fetch(BASE, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });

    const out = await res.json();
    if (!out.ok) {
      setStatus(`Erreur submit: ${out.error}`);
      isSubmitting = false;
      nextBtn.disabled = false;
      return;
    }

    // Lock UI
    nextBtn.disabled = true;
    minR.disabled = true;
    maxR.disabled = true;

    setStatus(`Terminé ✅ Score: ${out.score20} / 20`);
  }

  nextBtn.addEventListener("click", async () => {
    if (!currentQ || isSubmitting) return;

    const {min, max} = captureCurrentInterval();
    collected.push({ qId: currentQ.qId, min, max });

    if (qNum >= QUESTIONS_PER_ROUND) {
      isSubmitting = true;
      nextBtn.disabled = true;
      await submitRound();
    } else {
      await loadNextQuestion();
    }
  });

  // ---- Start screen ----
  function validateStart() {
    const name = playerNameInput.value.trim();
    const nameOk = name.length > 0;
    const sessionOk = !!sessionId;

    startBtn.disabled = !(nameOk && sessionOk);

    if (!sessionOk) startHint.textContent = "Aucune session sélectionnée (retour Home)";
    else if (!nameOk) startHint.textContent = "Entre un pseudo";
    else startHint.textContent = "";
  }

  playerNameInput.addEventListener("input", validateStart);

  startBtn.addEventListener("click", async () => {
    currentPlayerName = playerNameInput.value.trim();
    if (!currentPlayerName || !sessionId) return;

    startCard.style.display = "none";
    gameArea.style.display = "block";

    // init state
    isSubmitting = false;
    askedQids = [];
    collected = [];
    currentQ = null;
    qNum = 0;

    try {
      await loadNextQuestion();
    } catch (e) {
      console.error("[ENTRE2] loadNextQuestion failed", e);
      setStatus("Erreur au chargement de la 1ère question (voir console).");
      startCard.style.display = "block";
      gameArea.style.display = "none";
    }
  });

  // ---- Init ----
  if (!sessionId) {
    setStatus("Lien invalide : aucune session sélectionnée (retour Home).");
  }
  validateStart();
</script>
</body>
</html>

