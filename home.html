<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MASH — Home</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:920px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{padding:16px;border:1px solid #ddd;border-radius:14px;margin:12px 0}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:999px}
    .muted{opacity:.7}
    button,a.btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;text-decoration:none}
    button:disabled{opacity:.5;cursor:not-allowed}
    h1{margin:0 0 6px}
    .sessionTitle{font-weight:800;font-size:18px;margin:0 0 8px}
  </style>
</head>
<body>
  <h1>MASH</h1>
  <p class="muted">Choisis une session, puis un jeu.</p>

  <div class="row">
    <span class="pill" id="sessionPill">Session: -</span>
    <button id="clearSession">Effacer session</button>
    <span class="muted" id="status"></span>
  </div>

  <div id="sessionsRoot"></div>

<script>
  const BASE = "COLLE_ICI_TON_URL_APPS_SCRIPT"; // .../exec

  const sessionsRoot = document.getElementById("sessionsRoot");
  const sessionPill = document.getElementById("sessionPill");
  const statusEl = document.getElementById("status");

  const KEY_SESSION = "mash_sessionId";

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  function getSession(){ return (localStorage.getItem(KEY_SESSION) || "").trim(); }
  function setSession(id){
    localStorage.setItem(KEY_SESSION, id);
    sessionPill.textContent = `Session: ${id}`;
  }
  function clearSession(){
    localStorage.removeItem(KEY_SESSION);
    sessionPill.textContent = "Session: -";
  }

  document.getElementById("clearSession").addEventListener("click", () => {
    clearSession();
  });

  function routeForGameName(gameName){
    const g = (gameName || "").toUpperCase().trim();
    if (g === "INTERRO") return "./INTERRO.html";     // page quiz existante
    if (g === "ENTRE2")  return "./ENTRE2.html";
    // fallback : plus tard
    return "#";
  }

  function renderSessions(sessions){
    sessionsRoot.innerHTML = "";

    if (!sessions || sessions.length === 0){
      const d = document.createElement("div");
      d.className = "card";
      d.textContent = "Aucune session OPEN trouvée.";
      sessionsRoot.appendChild(d);
      return;
    }

    sessions.forEach(s => {
      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "sessionTitle";
      title.textContent = `Session ${s.sessionId}`;
      card.appendChild(title);

      const row = document.createElement("div");
      row.className = "row";

      s.games.forEach(g => {
        const btn = document.createElement("button");
        btn.textContent = `${g.game}`;
        btn.title = `status: ${g.status}${g.expectedPlayers ? " | joueurs: "+g.expectedPlayers : ""}`;

        const href = routeForGameName(g.game);
        btn.disabled = (href === "#") || (g.status !== "OPEN");

        btn.addEventListener("click", () => {
          setSession(s.sessionId);
          // redirection sans SessionID dans l’URL
          location.href = href;
        });

        row.appendChild(btn);
      });

      card.appendChild(row);
      sessionsRoot.appendChild(card);
    });
  }

  async function load(){
    const current = getSession();
    sessionPill.textContent = current ? `Session: ${current}` : "Session: -";

    setStatus("Chargement des sessions…");
    try{
      const url = `${BASE}?action=sessions&openOnly=1`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.ok){
        setStatus(`Erreur: ${data.error}`);
        return;
      }

      renderSessions(data.sessions);
      setStatus("");
    }catch(e){
      console.warn(e);
      setStatus("Erreur réseau ou URL BASE incorrecte.");
    }
  }

  load();
</script>
</body>
</html>

